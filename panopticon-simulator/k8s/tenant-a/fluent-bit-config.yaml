apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: tenant-a
  labels:
    app: fluent-bit
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        1
        Daemon       Off
        Log_Level    info
        Parsers_File parsers.conf

    [INPUT]
        Name              tail
        Path              /var/log/containers/*_tenant-a_*.log
        Exclude_Path      /var/log/containers/ingest-server*.log,/var/log/containers/otel-collector*.log,/var/log/containers/fluent-bit*.log
        multiline.parser  docker, cri
        Tag               kube.*
        Refresh_Interval  5
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On

    [FILTER]
        Name                parser
        Match               kube.*
        Key_Name            log
        Parser              json
        Reserve_Data        On
        Preserve_Key        Off

    # [FILTER]
    #     Name              lua
    #     Match             kube.*
    #     script            /fluent-bit/etc/shape.lua
    #     call              shape_record

    [OUTPUT]
        Name  http
        Match *
        # Local ingest-server for debugging
        Host  ingest-server.tenant-a.svc.cluster.local
        Port  4318
        URI   /v1/logs
        Format json
        Json_date_key timestamp
        Json_date_format iso8601
        tls   Off

  parsers.conf: |
    [PARSER]
        Name   docker
        Format json
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep On

    [PARSER]
        Name   cri
        Format regex
        Regex  ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name   json
        Format json

  shape.lua: |
    local allowed_apps = {
      backend = true,
      frontend = true
    }

    function shape_record(tag, timestamp, record)
      -- Check if app is allowed
      local app = nil
      if record["kubernetes"] and record["kubernetes"]["labels"] then
        app = record["kubernetes"]["labels"]["app"]
      end

      if app == nil or allowed_apps[app] ~= true then
        return -1, 0, 0
      end

      -- If log is already structured JSON with required fields, pass it through
      if record["type"] == "log" and record["service_name"] and record["message"] then
        -- Already properly formatted, just clean up kubernetes metadata
        local payload = {
          type = record["type"],
          timestamp = record["timestamp"],
          service_name = record["service_name"],
          environment = record["environment"],
          level = record["level"],
          message = record["message"],
          trace_id = record["trace_id"],
          span_id = record["span_id"],
        }

        -- Add HTTP fields if present
        if record["http_method"] then
          payload["http_method"] = record["http_method"]
          payload["http_path"] = record["http_path"]
          payload["http_status_code"] = record["http_status_code"]
        end

        return 1, timestamp, payload
      end

      -- Otherwise, build payload from raw log
      local payload = {
        type = "log",
        timestamp = record["time"] or os.date("!%Y-%m-%dT%H:%M:%S.000Z"),
        service_name = app or "unknown",
        environment = "unknown",
        level = "INFO",
        message = record["log"] or tostring(record),
        trace_id = nil,
        span_id = nil,
      }

      return 1, timestamp, payload
    end
